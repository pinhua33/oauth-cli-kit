name: Release (Auto Tag)

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "版本号自增类型：patch/minor/major"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  # 发布到 PyPI（Trusted Publishing）需要 OIDC token
  id-token: write

env:
  # GitHub Hosted Runner 无法访问内网源，强制使用公开 PyPI。
  UV_INDEX_URL: https://pypi.org/simple
  PIP_INDEX_URL: https://pypi.org/simple

jobs:
  tag:
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/project/oauth-cli-kit/
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 需要完整历史与 tags

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Compute next tag
        id: next
        env:
          BUMP: ${{ inputs.bump }}
        run: |
          set -euo pipefail

          git fetch --tags --force

          # 取最新的 vX.Y.Z tag；没有则从 v0.1.0 开始（可按你们习惯改）
          latest="$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)"
          if [ -z "$latest" ]; then
            latest="v0.1.0"
          fi

          ver="${latest#v}"
          # 这里不要用 heredoc（在 YAML 的 run: | 中容易因缩进导致语法错误）
          IFS='.' read -r major minor patch <<< "$ver"

          major="${major:-0}"
          minor="${minor:-0}"
          patch="${patch:-0}"

          case "$BUMP" in
            major)
              major=$((major + 1)); minor=0; patch=0
              ;;
            minor)
              minor=$((minor + 1)); patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
            *)
              echo "Unknown bump: $BUMP" >&2
              exit 1
              ;;
          esac

          next="v${major}.${minor}.${patch}"
          echo "latest=$latest" >> "$GITHUB_OUTPUT"
          echo "tag=$next" >> "$GITHUB_OUTPUT"

      - name: Create tag (local)
        env:
          TAG: ${{ steps.next.outputs.tag }}
          LATEST: ${{ steps.next.outputs.latest }}
        run: |
          set -euo pipefail
          echo "Latest tag: $LATEST"
          echo "Next tag:   $TAG"

          # 防止重复 tag
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag already exists: $TAG" >&2
            exit 1
          fi

          git tag -a "$TAG" -m "Release $TAG"

      - name: Build
        # 版本号来自 git tag（hatch-vcs），必须先创建 tag 再构建。
        run: uv build

      - name: Publish
        # 发布 dist/ 下的构建产物到 PyPI（使用 OIDC Trusted Publishing）。
        run: uv publish

      - name: Push tag
        env:
          TAG: ${{ steps.next.outputs.tag }}
        run: |
          set -euo pipefail
          git push origin "$TAG"

      - name: Note
        env:
          TAG: ${{ steps.next.outputs.tag }}
        run: |
          echo "已发布并推送 tag: $TAG"
